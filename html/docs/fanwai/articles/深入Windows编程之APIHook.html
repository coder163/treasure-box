<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="generator" content="VNote">

    <title>深入Windows编程之APIHook</title>
    <link rel="icon" href="https://github.com/tamlok/vnote/raw/master/src/resources/icons/vnote.ico">

    <style type="text/css">
    body { background-color: transparent !important; }

    </style>

    <style type="text/css">
    /* STYLE_OUTLINE_PLACE_HOLDER */
    /* STYLE_PLACE_HOLDER */
    </style>

    <!-- EXTRA_PLACE_HOLDER -->

<!-- HEAD_PLACE_HOLDER -->
</head>
<body>
<div class="container-fluid">
<div class="row flex-xl-nowrap">
    <div id="outline-panel" style="display:none;" class="d-none d-md-block d-xl-block col-md-3 col-xl-2 bd-toc">
        <div id="outline-content" class="section-nav"></div>
    </div>
    <div id="post-content" class="col-12 col-md-9 col-xl-10 py-md-3 pl-md-5 bd-content">
    <p>今天这篇文章我们来聊一下API Hook也就是平时所说的钩子</p>
<p>API Hook是什么意思？其实就是钩住API，那又何谓"钩"呢？就是让API函数的调用先绕一个弯路，在它执行实际功能之前，可以先做一些预处理，这样我们可以监视或者定制某个Win32 API的调用，以实现一些特殊的功能</p>
<p>为什么要使用 API Hook呢? 因为在很多情况下，想监视或者改变某个应用程序的一些特定操作，但是该应用程序却没有提供相应的接口，而又几乎不可能得到其源代码(例如，我们很多游戏辅助爱好者想让我自己的程序被加载到游戏进程当中)，怎么办呢？因为大多数Windows应用程序的操作很大程度上依赖于API，所以我们可以采用API Hook的方式来试图监视和改变应用程序的行为</p>
<p>常用的API Hook有两种方式：陷阱式和改引入表式，API Hook的运行平台有三种，Windows9x的16位DLL、Windows9x的32位DLL和WindowsNT/2000的32位DLL，其关系如下</p>
<table>
<thead>
<tr>
<th>方式</th>
<th>16位Windows9x</th>
<th>32位Windows9x</th>
<th>WindowsNT/2000</th>
</tr>
</thead>
<tbody>
<tr>
<td>陷阱式</td>
<td>√</td>
<td>-</td>
<td>√</td>
</tr>
<tr>
<td>改引入表式</td>
<td>×</td>
<td>O</td>
<td>√</td>
</tr>
</tbody>
</table>
<blockquote>
<p>X表示不能实现；0表示只对指定模块有效，对整个进程或者操作系统无效；-表示在VC下可以实现，在Delphi下很难实现；√ 表示可以实现</p>
</blockquote>
<p>我们今天不讨论这两种方式的优劣和区别，而且这其中有很多复杂的细节问题，后期再慢慢深入，现在我们来一个例子</p>
<p><strong>exe工程</strong></p>
<pre><code class="lang-pascal hljs"><span class="hljs-keyword">unit</span> UMainForm;

<span class="hljs-keyword">interface</span>

<span class="hljs-keyword">uses</span>
  Generics.Collections, UBaseTools, TlHelp32, Winapi.Windows, Winapi.Messages,
  System.SysUtils, System.Variants, System.Classes, Vcl.Graphics, Vcl.Controls,
  Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ComCtrls;

<span class="hljs-keyword">type</span>
  <span class="hljs-title">TForm1</span> = <span class="hljs-keyword">class</span>(TForm)
    grp1: TGroupBox;
    mmo1: TMemo;
    btn2: TButton;
    btn3: TButton;
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">FormCreate</span><span class="hljs-params">(Sender: TObject)</span>;</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">btn2Click</span><span class="hljs-params">(Sender: TObject)</span>;</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">btn3Click</span><span class="hljs-params">(Sender: TObject)</span>;</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">FormDestroy</span><span class="hljs-params">(Sender: TObject)</span>;</span>
  <span class="hljs-keyword">private</span>
    <span class="hljs-comment">{ Private declarations }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">WndProc</span><span class="hljs-params">(<span class="hljs-keyword">var</span> <span class="hljs-keyword">Message</span>: TMessage)</span>;</span> <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">public</span>
    <span class="hljs-comment">{ Public declarations }</span>
  <span class="hljs-keyword">end</span>;

<span class="hljs-keyword">var</span>
  Form1: TForm1;

<span class="hljs-keyword">implementation</span>


<span class="hljs-meta">{$R *.dfm}</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AdjustProcessPrivilege</span><span class="hljs-params">(ProcessHandle: THandle; Token_Name: Pchar)</span>:</span> boolean;
<span class="hljs-keyword">var</span>
  Token: THandle;
  TokenPri: _TOKEN_PRIVILEGES;
  ProcessDest: int64;
  l: DWORD;
<span class="hljs-keyword">begin</span>
  Result := False;
  <span class="hljs-keyword">if</span> OpenProcessToken(ProcessHandle, TOKEN_ADJUST_PRIVILEGES, Token) <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">if</span> LookupPrivilegeValue(<span class="hljs-keyword">nil</span>, Token_Name, ProcessDest) <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">begin</span>
      TokenPri.PrivilegeCount := <span class="hljs-number">1</span>;
      TokenPri.Privileges[<span class="hljs-number">0</span>].Attributes := SE_PRIVILEGE_ENABLED;
      TokenPri.Privileges[<span class="hljs-number">0</span>].Luid := ProcessDest;
      l := <span class="hljs-number">0</span>;
      <span class="hljs-comment">//更新进程令牌，成功返回TRUE</span>
      <span class="hljs-keyword">if</span> AdjustTokenPrivileges(Token, False, TokenPri, sizeof(TokenPri), <span class="hljs-keyword">nil</span>, l) <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">begin</span>
        Form1.mmo1.Lines.Add(<span class="hljs-string">'更新进程令牌成功！'</span>);
        Result := True;

      <span class="hljs-keyword">end</span>;

    <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">InjectDll</span><span class="hljs-params">(<span class="hljs-keyword">const</span> DllFullPath: <span class="hljs-keyword">string</span>; <span class="hljs-keyword">const</span> dwRemoteProcessId: Cardinal)</span>:</span> Boolean;
<span class="hljs-keyword">var</span>
  hRemoteProcess, hRemoteThread: THandle;
  pszLibFileRemote: Pointer;
  pszLibAFilename: PwideChar;
  pfnStartAddr: TFNThreadStartRoutine;
  memSize, lpThreadId: Cardinal;
  WriteSize: SIZE_T;
<span class="hljs-keyword">begin</span>
  Result := false;
  <span class="hljs-comment">// 调整权限，使程序可以访问其他进程的内存空间</span>
  <span class="hljs-keyword">if</span> AdjustProcessPrivilege(GetCurrentProcess, <span class="hljs-string">'SeDebugPrivilege'</span>) <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span>
    <span class="hljs-comment">//打开远程线程 PROCESS_ALL_ACCESS 参数表示打开所有的权限</span>
    hRemoteProcess := OpenProcess(PROCESS_ALL_ACCESS, false, dwRemoteProcessId);
    Form1.mmo1.Lines.Add(<span class="hljs-string">'打开远程线程：'</span> + IntToStr(hRemoteProcess) + <span class="hljs-string">':'</span> + DwordToStr(dwRemoteProcessId));
    <span class="hljs-keyword">try</span>
      <span class="hljs-comment">// 为注入的dll文件路径分配内存大小,由于为WideChar,故要乘2</span>
      GetMem(pszLibAFilename, Length(DllFullPath) * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>);
      <span class="hljs-comment">// 之所以要转换成 WideChar, 是因为当DLL位于有中文字符的路径下时不会出错</span>
      StringToWideChar(DllFullPath, pszLibAFilename, Length(DllFullPath) * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>);
      <span class="hljs-comment">// 计算 pszLibAFilename 的长度，注意，是以字节为单元的长度</span>
      memSize := (<span class="hljs-number">1</span> + lstrlenW(pszLibAFilename)) * SizeOf(WCHAR);

      <span class="hljs-comment">// 使用VirtualAllocEx函数在远程进程的内存地址空间分配DLL文件名空间</span>
      pszLibFileRemote := VirtualAllocEx(hRemoteProcess, <span class="hljs-keyword">nil</span>, memSize, MEM_COMMIT, PAGE_READWRITE);

      <span class="hljs-keyword">if</span> Assigned(pszLibFileRemote) <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">begin</span>
        <span class="hljs-comment">// 使用WriteProcessMemory函数将DLL的路径名写入到远程进程的内存空间</span>
        <span class="hljs-keyword">if</span> WriteProcessMemory(hRemoteProcess, pszLibFileRemote, pszLibAFilename, memSize, WriteSize) <span class="hljs-keyword">and</span> (WriteSize = memSize) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">begin</span>
          lpThreadId := <span class="hljs-number">0</span>;
          <span class="hljs-comment">// 计算LoadLibraryW的入口地址</span>
          pfnStartAddr := GetProcAddress(LoadLibrary(<span class="hljs-string">'Kernel32.dll'</span>), <span class="hljs-string">'LoadLibraryW'</span>);
          <span class="hljs-comment">// 启动远程线程LoadLbraryW,通过远程线程调用创建新的线程</span>
          hRemoteThread := CreateRemoteThread(hRemoteProcess, <span class="hljs-keyword">nil</span>, <span class="hljs-number">0</span>, pfnStartAddr, pszLibFileRemote, <span class="hljs-number">0</span>, lpThreadId);
          Form1.mmo1.Lines.Add(<span class="hljs-string">'启动远程线程：'</span> + IntToStr(hRemoteThread));
          <span class="hljs-comment">// 如果执行成功返回　True;</span>
          <span class="hljs-keyword">if</span> (hRemoteThread &lt;&gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span>
          <span class="hljs-keyword">begin</span>
            Result := true;
          <span class="hljs-keyword">end</span>;
          <span class="hljs-comment">// 释放句柄</span>
          CloseHandle(hRemoteThread);
        <span class="hljs-keyword">end</span>;
      <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">finally</span>
      <span class="hljs-comment">// 释放句柄</span>
      CloseHandle(hRemoteProcess);
    <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">SetHook</span><span class="hljs-params">(dwThreadId: DWORD; pid: DWORD)</span>;</span> <span class="hljs-keyword">stdcall</span>; <span class="hljs-keyword">external</span> <span class="hljs-string">'KeyBoardHook'</span>;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">StopHook</span>;</span> <span class="hljs-keyword">stdcall</span>; <span class="hljs-keyword">external</span> <span class="hljs-string">'KeyBoardHook'</span>;

<span class="hljs-comment">// 注入</span>

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TForm1</span>.<span class="hljs-title">btn2Click</span><span class="hljs-params">(Sender: TObject)</span>;</span>
<span class="hljs-keyword">var</span>
  <span class="hljs-comment">{定义一个泛型 TList 类, 这指定了要用于 string}</span>
  List1: TList&lt;Cardinal&gt;;
<span class="hljs-keyword">var</span>
  i: Integer;
<span class="hljs-keyword">var</span>
  IsTrue: Boolean;
<span class="hljs-keyword">begin</span>
  List1 := ListPids(<span class="hljs-string">'测试程序.exe'</span>);

  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> List1.Count - <span class="hljs-number">1</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    IsTrue := InjectDll(<span class="hljs-string">'KeyBoardHook.dll'</span>, List1[i]);
    SetHook(List1[i], GetCurrentProcessId);
    mmo1.Lines.Add(<span class="hljs-string">'进程PID2：'</span> + List1[i].ToString + <span class="hljs-string">'，注入结果：'</span> + IsTrue.ToString);
  <span class="hljs-keyword">end</span>;
  List1.Free;
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TForm1</span>.<span class="hljs-title">FormCreate</span><span class="hljs-params">(Sender: TObject)</span>;</span>
<span class="hljs-keyword">begin</span>
  mmo1.Lines.Clear;
  mmo1.Font.Color := clGreen;
<span class="hljs-keyword">end</span>;



<span class="hljs-comment">//接收消息</span>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TForm1</span>.<span class="hljs-title">WndProc</span><span class="hljs-params">(<span class="hljs-keyword">var</span> <span class="hljs-keyword">Message</span>: TMessage)</span>;</span>
<span class="hljs-keyword">var</span>
  hSnapShot: THandle;
  pEntry: TProcessEntry32;
  find: Boolean;
  proName: <span class="hljs-keyword">string</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">Message</span>.Msg = WM_USER + <span class="hljs-number">101</span> <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span>
    <span class="hljs-comment">//创建进程快照</span>
    hSnapShot := CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);
    pEntry.dwSize := SizeOf(pEntry);
    find := Process32First(hSnapShot, pEntry);
    <span class="hljs-keyword">while</span> find <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">begin</span>
      <span class="hljs-comment">//取进程名字</span>
      proName := pEntry.szExeFile;
      <span class="hljs-keyword">if</span> pEntry.th32ProcessID = <span class="hljs-keyword">Message</span>.LParam <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">Break</span>;
      find := Process32Next(hSnapShot, pEntry);
    <span class="hljs-keyword">end</span>;
    mmo1.Lines.Add(<span class="hljs-string">'进程：'</span> + proName + <span class="hljs-string">',ID：'</span> + IntToStr(<span class="hljs-keyword">Message</span>.LParam) + <span class="hljs-string">'按下按键：'</span> + Chr(<span class="hljs-keyword">Message</span>.WParam));
    CloseHandle(hSnapShot);
  <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">inherited</span>;

<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">end</span>.
</code></pre>
<p><strong>exe下的工具单元(UBaseTools.pas)</strong></p>
<pre><code class="lang-pascal hljs"><span class="hljs-keyword">unit</span> UBaseTools;

<span class="hljs-keyword">interface</span>

<span class="hljs-keyword">uses</span>
  Generics.Collections, psapi, Variants, Winapi.Windows, Winapi.Messages, TLHelp32, Vcl.StdCtrls, System.SysUtils, Vcl.Dialogs;



<span class="hljs-comment">{*------------------------------------------------------------------------------
  枚举游戏进程，获取所有的PID

  @param ProName
  @return
-------------------------------------------------------------------------------}</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ListPids</span><span class="hljs-params">(ProName: <span class="hljs-keyword">string</span>)</span>:</span> TList&lt;Cardinal&gt;;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StrToDword</span><span class="hljs-params">(Value: <span class="hljs-keyword">string</span>)</span>:</span> DWORD;

 <span class="hljs-comment">// DwordToStr() : Converts a DWORD to a 4 byte string</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DwordToStr</span><span class="hljs-params">(Value: dword)</span>:</span> <span class="hljs-keyword">string</span>;

<span class="hljs-keyword">implementation</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ListPids</span><span class="hljs-params">(ProName: <span class="hljs-keyword">string</span>)</span>:</span> TList&lt;Cardinal&gt;;
<span class="hljs-keyword">var</span>
  ContinueLoop: BOOL;       <span class="hljs-comment">//是否继续循环</span>
  FSnapshotHandle: THandle; <span class="hljs-comment">//进程快照句柄</span>
  FProcessEntry32: TProcessEntry32; <span class="hljs-comment">//进程入口的结构体信息</span>
  pids: <span class="hljs-keyword">string</span>;
  pid: Integer;
  hProcess: THandle;
  ProcessFullPathName: <span class="hljs-keyword">string</span>;
  buf: <span class="hljs-keyword">array</span>[<span class="hljs-number">0</span>..MAX_PATH] <span class="hljs-keyword">of</span> Char;
  buf1: <span class="hljs-keyword">array</span>[<span class="hljs-number">0</span>..MAX_PATH] <span class="hljs-keyword">of</span> Char;
<span class="hljs-keyword">var</span>
  List: TList&lt;Cardinal&gt;;  <span class="hljs-comment">{定义一个泛型 TList 类, 这指定了要用于 string}</span>
<span class="hljs-keyword">begin</span>
  List := TList&lt;Cardinal&gt;.Create;
  FSnapshotHandle := CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);
<span class="hljs-comment">//CreateToolhelp32Snapshot函数得到进程快照</span>
  FProcessEntry32.dwSize := Sizeof(FProcessEntry32); <span class="hljs-comment">//初始化</span>
  ContinueLoop := Process32First(FSnapshotHandle, FProcessEntry32);
<span class="hljs-comment">//Process32First 得到一个系统快照里第一个进程的信息</span>

  <span class="hljs-keyword">while</span> ContinueLoop <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
   <span class="hljs-comment">//进程ID</span>
    pid := FProcessEntry32.th32ProcessID;

    hProcess := OpenProcess(PROCESS_QUERY_INFORMATION <span class="hljs-keyword">or</span> PROCESS_VM_READ, FALSE, pid);
    <span class="hljs-keyword">if</span> hProcess &lt;&gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">begin</span>
      <span class="hljs-keyword">if</span> StrPas(FProcessEntry32.szExeFile) = ProName <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">begin</span>
        List.Add(FProcessEntry32.th32ProcessID);
      <span class="hljs-keyword">end</span>;

    <span class="hljs-keyword">end</span>;

    ContinueLoop := Process32Next(FSnapshotHandle, FProcessEntry32);
  <span class="hljs-keyword">end</span>;
  CloseHandle(FSnapshotHandle);
  Result := List;
<span class="hljs-keyword">end</span>;
</code></pre>
<p>DLL工程</p>
<pre><code class="lang-Pascal hljs"><span class="hljs-keyword">library</span> KeyBoardHook;

<span class="hljs-comment">{ Important note about DLL memory management: ShareMem must be the
  first unit in your library's USES clause AND your project's (select
  Project-View Source) USES clause if your DLL exports any procedures or
  functions that pass strings as parameters or function results. This
  applies to all strings passed to and from your DLL--even those that
  are nested in records and classes. ShareMem is the interface unit to
  the BORLNDMM.DLL shared memory manager, which must be deployed along
  with your DLL. To avoid using BORLNDMM.DLL, pass string information
  using PChar or ShortString parameters. }</span>

<span class="hljs-keyword">uses</span>
  SysUtils,
  Windows,
  Messages,
  Vcl.Dialogs,
  Classes,
  UMainForm <span class="hljs-keyword">in</span> <span class="hljs-string">'UMainForm.pas'</span> <span class="hljs-comment">{MainForm}</span>,
  UPublicTool <span class="hljs-keyword">in</span> <span class="hljs-string">'utils\UPublicTool.pas'</span>;

<span class="hljs-keyword">var</span>
  fHook: HHOOK;

<span class="hljs-keyword">type</span>
  IntProc = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>:</span> DWORD;

<span class="hljs-keyword">var</span>
  ParentPid: DWORD = <span class="hljs-number">101</span>;

<span class="hljs-meta">{$R *.res}</span>
<span class="hljs-comment">//回调函数</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">HookProc</span><span class="hljs-params">(code: Integer; wParam: wParam; lParam: lParam)</span>:</span> LRESULT; <span class="hljs-keyword">stdcall</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//如果有键盘动作</span>
  <span class="hljs-keyword">if</span> code = HC_Action <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">if</span> (wParam = VK_HOME) <span class="hljs-keyword">and</span> ((<span class="hljs-number">1</span> <span class="hljs-keyword">shl</span> <span class="hljs-number">31</span>) <span class="hljs-keyword">and</span> lParam = <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">begin</span>
      <span class="hljs-keyword">if</span> MainForm = <span class="hljs-keyword">nil</span> <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">begin</span>
        MainForm := TMainForm.CreateParented(GetHWndByPID(lParam));
      <span class="hljs-keyword">end</span>;

      MainForm.Caption := <span class="hljs-string">'操蛋的回调函数：'</span> + inttostr(ParentPid);
      MainForm.Visible := <span class="hljs-keyword">not</span> MainForm.Visible;
    <span class="hljs-keyword">end</span>;

  <span class="hljs-keyword">end</span>;

  Result := CallNextHookEx(fHook, code, wParam, lParam);
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">SetHook</span><span class="hljs-params">(dwThreadId: DWORD)</span>;</span> <span class="hljs-keyword">stdcall</span>;
<span class="hljs-keyword">begin</span>
  ParentPid := <span class="hljs-number">123</span>;
  ShowMessage(<span class="hljs-string">'宿主进程的ID:'</span> + IntToStr(ParentPid));
  <span class="hljs-comment">//挂钩，这里没有做挂钩失败的提示</span>
  fHook := SetWindowsHookEx(WH_KEYBOARD, @HookProc, HInstance, GetWindowThreadProcessId(GetHWndByPID(dwThreadId)));
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">StopHook</span>;</span> <span class="hljs-keyword">stdcall</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//摘钩</span>
  <span class="hljs-keyword">if</span> fHook &lt;&gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    UnhookWindowsHookEx(fHook);
<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">exports</span>
  SetHook <span class="hljs-keyword">name</span> <span class="hljs-string">'SetHook'</span>,
  StopHook <span class="hljs-keyword">name</span> <span class="hljs-string">'StopHook'</span>,
  HookProc <span class="hljs-keyword">name</span> <span class="hljs-string">'HookProc'</span>;

<span class="hljs-keyword">begin</span>

  <span class="hljs-comment">//ShowMessage('线程ID：' + IntToStr(GetCurrentProcessId));</span>

<span class="hljs-keyword">end</span>.
</code></pre>
<p><strong>DLL下的工具函数单元(DLL\utils\UPublicTool.pas)</strong></p>
<pre><code class="lang-Pascal hljs"><span class="hljs-keyword">unit</span> UPublicTool;

<span class="hljs-keyword">interface</span>

<span class="hljs-keyword">uses</span>
  SysUtils, Windows, Messages, Vcl.Dialogs, Classes;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GetHWndByPID</span><span class="hljs-params">(<span class="hljs-keyword">const</span> hPID: THandle)</span>:</span> THandle;

<span class="hljs-keyword">implementation</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GetHWndByPID</span><span class="hljs-params">(<span class="hljs-keyword">const</span> hPID: THandle)</span>:</span> THandle;
<span class="hljs-keyword">type</span>
  PEnumInfo = ^TEnumInfo;

  TEnumInfo = <span class="hljs-keyword">record</span>
    ProcessID: DWORD;
    HWND: THandle;
  <span class="hljs-keyword">end</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EnumWindowsProc</span><span class="hljs-params">(Wnd: DWORD; <span class="hljs-keyword">var</span> EI: TEnumInfo)</span>:</span> Bool; <span class="hljs-keyword">stdcall</span>;
  <span class="hljs-keyword">var</span>
    PID: DWORD;
  <span class="hljs-keyword">begin</span>
    GetWindowThreadProcessID(Wnd, @PID);
    Result := (PID &lt;&gt; EI.ProcessID) <span class="hljs-keyword">or</span> (<span class="hljs-keyword">not</span> IsWindowVisible(Wnd)) <span class="hljs-keyword">or</span> (<span class="hljs-keyword">not</span> IsWindowEnabled(Wnd));

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Result <span class="hljs-keyword">then</span>
      EI.HWND := Wnd; <span class="hljs-comment">//break on return FALSE 所以要反向檢查</span>
  <span class="hljs-keyword">end</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FindMainWindow</span><span class="hljs-params">(PID: DWORD)</span>:</span> DWORD;
  <span class="hljs-keyword">var</span>
    EI: TEnumInfo;
  <span class="hljs-keyword">begin</span>
    EI.ProcessID := PID;
    EI.HWND := <span class="hljs-number">0</span>;
    EnumWindows(@EnumWindowsProc, Integer(@EI));
    Result := EI.HWND;
  <span class="hljs-keyword">end</span>;

<span class="hljs-keyword">begin</span>
  <span class="hljs-keyword">if</span> hPID &lt;&gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    Result := FindMainWindow(hPID)
  <span class="hljs-keyword">else</span>
    Result := <span class="hljs-number">0</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">end</span>.
</code></pre>
<blockquote>
<p>以上代码仅仅是测试代码，可能还存在一些问题，例如：卸载DLL和卸载键盘钩子，但是这并不影响我们今天的知识点理解</p>
</blockquote>
<p>这里面还牵扯到一些其他的知识，比如DLL，当然也有我们昨天说的函数指针，限于篇幅问题，我后续再慢慢介绍</p>

    </div>
</div>
</div>

<div id="container-floating" style="display:none;" class="d-none d-md-block d-xl-block">
    <div id="floating-button" onclick="toggleMore()">
        <p id="floating-more" class="more">&gt;</p>
    </div>
</div>

<!--
<div class="footer" id="vnote-footer">
    <p>Generated by <em><a href="https://tamlok.github.io/vnote/">VNote</a></em>.</p>
</div>
-->
</body>
</html>
