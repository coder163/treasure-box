<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="generator" content="VNote">

    <title>023-多线程开篇</title>
    <link rel="icon" href="https://github.com/tamlok/vnote/raw/master/src/resources/icons/vnote.ico">

    <style type="text/css">
    body { background-color: transparent !important; }

    </style>

    <style type="text/css">
    /* STYLE_OUTLINE_PLACE_HOLDER */
    /* STYLE_PLACE_HOLDER */
    </style>

    <!-- EXTRA_PLACE_HOLDER -->

<!-- HEAD_PLACE_HOLDER -->
</head>
<body>
<div class="container-fluid">
<div class="row flex-xl-nowrap">
    <div id="outline-panel" style="display:none;" class="d-none d-md-block d-xl-block col-md-3 col-xl-2 bd-toc">
        <div id="outline-content" class="section-nav"></div>
    </div>
    <div id="post-content" class="col-12 col-md-9 col-xl-10 py-md-3 pl-md-5 bd-content">
    <blockquote>
<p>这是一篇很枯燥的文章，可能很多人会觉得没有什么卵用。但是只有在搞清楚理论之后才可以完美的去实现。所以这篇文章作为多线程的开篇</p>
</blockquote>
<p>其实多线程是一个很大的话题，我也仅仅停留在简单的应用，至于以后的深入只能靠自己</p>
<p><strong>时间切片</strong></p>
<p>在大多数支持多线程的系统中，可能有许多用户在计算机系统上同时发出请求。通常，系统中的物理处理器数量少于可能并行运行的线程数量。而此时就需要依靠时间切片完成，大多数系统都支持<strong>时间切片</strong>，也称为<strong>先发制人的多任务处理</strong>。</p>
<p>在时间切片的系统中，线程会运行一段时间，然后被抢占; 也就是说，硬件计时器触发，导致操作系统重新评估应运行哪些线程，可能停止对当前运行的线程执行，以及运行最近未执行的其他线程。这甚至允许单处理器机器运行多个线程。在PC上，时间片往往大约是五十五毫秒。</p>
<blockquote>
<p>55 毫秒的时间给人的感觉接近无感，以为是多个任务在同时运行。线程不应该改变程序的语义。他们只是改变了操作的时间。</p>
</blockquote>
<p>下面几种场景我们都需要多线程的方式来完成任务</p>
<ul>
<li>
<p>进行冗长的处理：当Windows应用程序正在计算时，它无法再处理任何消息。结果，无法更新显示。</p>
</li>
<li>
<p>进行后台处理：某些任务可能不是时间关键，但需要连续执行。</p>
</li>
<li>
<p>执行I / O工作：磁盘或网络的I / O可能会出现不可预测的延迟。线程允许您确保I / O延迟不会延迟应用程序的不相关部分。</p>
</li>
</ul>
<blockquote>
<p>时间切片的概念也不小，这里不做深入讨论，仅仅产生一个认知即可</p>
</blockquote>
<p>Delphi支持两种线程的启动方式，当然也有可能是 3 种</p>
<ul>
<li>
<p>Win32API</p>
</li>
<li>
<p>TTHread类</p>
</li>
<li>
<p>线程池：这种方式我没有用到，同时在掌握上面两种方式之后线程池自然也会掌握，所以我们把学习的重点放在前面两种</p>
</li>
</ul>
<p>Delphi使得线程启动变得容易。在获取子线程执行之前，通常需要在线程中设置一些初始状态。通过创建挂起的线程（构造函数的参数），可以确保线程中的所有代码都不会执行，直到线程恢复为止。</p>
<h2 id="toc_0">API启动<a class="vnote-anchor" href="#toc_0" data-anchor-icon="#"></a></h2>
<pre><code class="lang-pascal hljs"><span class="hljs-keyword">unit</span> Unit1;

<span class="hljs-keyword">interface</span>

<span class="hljs-keyword">uses</span>
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls;

<span class="hljs-keyword">type</span>
  <span class="hljs-title">TForm1</span> = <span class="hljs-keyword">class</span>(TForm)
    btn2: TButton;
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">btn2Click</span><span class="hljs-params">(Sender: TObject)</span>;</span>
  <span class="hljs-keyword">private</span>
    <span class="hljs-comment">{ Private declarations }</span>
  <span class="hljs-keyword">public</span>
    <span class="hljs-comment">{ Public declarations }</span>
  <span class="hljs-keyword">end</span>;

<span class="hljs-keyword">var</span>
  Form1: TForm1;

<span class="hljs-keyword">implementation</span>

<span class="hljs-meta">{$R *.dfm}</span>
<span class="hljs-comment">{工作线程调入函数，stdcall用于多个线程排序以及系统级别调用加此关键字}</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MyFun</span><span class="hljs-params">(p:Pointer)</span>:</span>integer;<span class="hljs-keyword">stdcall</span>;
<span class="hljs-keyword">var</span>
  i:integer;
<span class="hljs-keyword">begin</span>
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> <span class="hljs-number">500000</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">with</span> Form1.Canvas <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">begin</span>
      Lock;
      <span class="hljs-comment">{50和10是坐标X和Y}</span>
      TextOut(<span class="hljs-number">50</span>,<span class="hljs-number">10</span>,IntToStr(i));
      Unlock;
      Application.ProcessMessages;
    <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;


<span class="hljs-comment">{工作线程，拖动窗口时计数不会停顿，因为和主线程分开工作了}</span>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TForm1</span>.<span class="hljs-title">btn2Click</span><span class="hljs-params">(Sender: TObject)</span>;</span>
<span class="hljs-keyword">var</span>
    <span class="hljs-comment">{用于接收线程返回句柄，也可以用DWORD}</span>
  ID:THandle;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">{API创建线程}</span>
  CreateThread(<span class="hljs-keyword">nil</span>,<span class="hljs-number">0</span>,@MyFun,<span class="hljs-keyword">nil</span>,<span class="hljs-number">0</span>,ID);
<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">end</span>.
</code></pre>
<h2 id="toc_1">TThread<a class="vnote-anchor" href="#toc_1" data-anchor-icon="#"></a></h2>
<p>其实在Delphi中更建议使用该类完成线程相关的操作</p>
<pre><code class="lang-pascal hljs"><span class="hljs-keyword">unit</span> UnitThread;

<span class="hljs-keyword">interface</span>

<span class="hljs-keyword">uses</span>
  Vcl.Forms, Vcl.Dialogs, System.SysUtils, System.Classes;

<span class="hljs-keyword">type</span>
  <span class="hljs-title">TMyThread</span> = <span class="hljs-keyword">class</span>(TThread)
  <span class="hljs-keyword">protected</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">Execute</span>;</span> <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;

<span class="hljs-keyword">implementation</span>

<span class="hljs-keyword">uses</span>
  UnitMain;

<span class="hljs-comment">{ TMyThread }</span>

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TMyThread</span>.<span class="hljs-title">Execute</span>;</span>
<span class="hljs-keyword">var</span>
  I: Integer;
<span class="hljs-keyword">begin</span>
  FreeOnTerminate := False;
  I := <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> True <span class="hljs-keyword">do</span> <span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">if</span> FreeOnTerminate <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">Exit</span>;
    form1.lbl1.Caption := <span class="hljs-string">'线程ID：'</span> + Self.ThreadID.ToString + <span class="hljs-string">'：'</span> + I.ToString;
    TThread.Sleep(<span class="hljs-number">300</span>);
    I := I + <span class="hljs-number">1</span>;
  <span class="hljs-keyword">end</span>;

<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">end</span>.

<span class="hljs-comment">{启动线程的代码}</span>

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TForm1</span>.<span class="hljs-title">btn1Click</span><span class="hljs-params">(Sender: TObject)</span>;</span>
<span class="hljs-keyword">begin</span>
  Thread := TMyThread.Create(True);
  Thread.Start;
<span class="hljs-keyword">end</span>;
</code></pre>
<blockquote>
<p>通过代码我可以很明显的发现 FreeOnTerminate 这玩意儿是可以控制线程的启停</p>
</blockquote>
<h3 id="toc_2">OnTerminate事件<a class="vnote-anchor" href="#toc_2" data-anchor-icon="#"></a></h3>
<p>当线程真正完成执行时，会发生OnTerminate事件。它并没有在终止线程的方法被调用发生。此事件可能非常有用，因为它在主VCL线程的上下文中执行，就像传递给同步的方法一样。因此，如果一个人希望用一个在终止时自动释放自己的线程来执行一些VCL操作，那么这就是它的地方。</p>
<p><img src='data:image/png;base64,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' alt="mark" class="view-image"></p>
<h3 id="toc_3">注意事项<a class="vnote-anchor" href="#toc_3" data-anchor-icon="#"></a></h3>
<p>要记住Execute()需要经常地检查Terminated属性的值，来确认是否要提前退出。尽管这将意味着当使用线程工作的时候，你必须关心更多的事情，但它能确保在线程结束时，能够完成必要的清除</p>
<p>在某些紧急情况下，你可以使用Win32 API函数 TerminateThread()来终止一个线程。但是，除非没有别的办法了，否则不要使用它。</p>

    </div>
</div>
</div>

<div id="container-floating" style="display:none;" class="d-none d-md-block d-xl-block">
    <div id="floating-button" onclick="toggleMore()">
        <p id="floating-more" class="more">&gt;</p>
    </div>
</div>

<!--
<div class="footer" id="vnote-footer">
    <p>Generated by <em><a href="https://tamlok.github.io/vnote/">VNote</a></em>.</p>
</div>
-->
</body>
</html>
