<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="generator" content="VNote">

    <title>单例设计模式</title>
    <link rel="icon" href="https://github.com/tamlok/vnote/raw/master/src/resources/icons/vnote.ico">

    <style type="text/css">
    /* STYLE_GLOBAL_PLACE_HOLDER */
    </style>

    <style type="text/css">
    /* STYLE_OUTLINE_PLACE_HOLDER */
    /* STYLE_PLACE_HOLDER */
    </style>

    <!-- EXTRA_PLACE_HOLDER -->

<!-- HEAD_PLACE_HOLDER -->
</head>
<body>
<div class="container-fluid">
<div class="row flex-xl-nowrap">
    <div id="outline-panel" style="display:none;" class="d-none d-md-block d-xl-block col-md-3 col-xl-2 bd-toc">
        <div id="outline-content" class="section-nav"></div>
    </div>
    <div id="post-content" class="col-12 col-md-9 col-xl-10 py-md-3 pl-md-5 bd-content">
    <p>可能Delphi王朝真的没落了，在网上查了很久都是一些重复、陈旧、残缺不全的帖子，搞的像古代的武功秘籍一样，每次只能获取上篇或者下篇，而这些上下还有可能是残篇</p>
<p>设计模式（Design pattern）代表了最佳的实践，通常被有经验的面向对象的软件开发人员所采用。设计模式是软件开发人员在软件开发过程中面临的一般问题的解决方案。这些解决方案是众多软件开发人员经过相当长的一段时间的试验和错误总结出来的。</p>
<blockquote>
<p>引自菜鸟教程</p>
</blockquote>
<p>从上面的话中不难看出，所谓的设计模式是针对一些常见问题总结出来的一套比较优质的解决方案，所以这个不限语言，所有语言通用</p>
<p>单例（Singleton）模式的定义：指一个类只有一个实例，且该类能自行创建这个实例的一种模式。例如，Windows 中只能打开一个任务管理器，这样可以避免因打开多个任务管理器窗口而造成内存资源的浪费，或出现各个窗口显示内容的不一致等错误。单例模式有 3 个特点</p>
<ul>
<li>单例类只有一个实例对象；</li>
<li>该单例对象必须由单例类自行创建；</li>
<li>单例类对外提供一个访问该单例的全局访问点；</li>
</ul>
<p>有人说单例是所有设计模式中最简单的，我只能呵呵，单例模式就我知道的Java中的写法就有7、8种之多，Delphi的还在摸索学习，为了方便学习，案例还是以控制台应用的形式呈现，尽量减少库和单元的引用</p>
<h1 id="toc_0">代码实现<a class="vnote-anchor" href="#toc_0" data-anchor-icon="#"></a></h1>
<p>本文代码在DelphiXE10.4版本下测试通过</p>
<pre><code class="lang-pascal hljs"><span class="hljs-keyword">unit</span> uCommonUtil;

<span class="hljs-keyword">interface</span>

<span class="hljs-keyword">uses</span>
    System.SysUtils;

<span class="hljs-keyword">type</span>
   <span class="hljs-comment">{ TSingle }</span>
    <span class="hljs-title">TSingle</span> = <span class="hljs-keyword">class</span>(TObject)
    <span class="hljs-keyword">private</span>
        FNum: <span class="hljs-keyword">string</span>;
    <span class="hljs-keyword">protected</span>
    <span class="hljs-keyword">public</span>
        <span class="hljs-function"><span class="hljs-keyword">constructor</span> <span class="hljs-title">Create</span>;</span>
        <span class="hljs-keyword">class</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GetInstance</span><span class="hljs-params">()</span>:</span> TSingle;
        <span class="hljs-keyword">class</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NewInstance</span>:</span> TObject; <span class="hljs-keyword">override</span>;
        <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">FreeInstance</span>;</span> <span class="hljs-keyword">override</span>;
        <span class="hljs-keyword">property</span> Str: <span class="hljs-keyword">string</span> <span class="hljs-keyword">read</span> FNum <span class="hljs-keyword">write</span> FNum;
    <span class="hljs-keyword">published</span>
    <span class="hljs-keyword">end</span>;

<span class="hljs-keyword">implementation</span>

<span class="hljs-keyword">var</span>
    GlobalSingle: TSingle;
   <span class="hljs-comment">{ TSingle }</span>

<span class="hljs-function"><span class="hljs-keyword">constructor</span> <span class="hljs-title">TSingle</span>.<span class="hljs-title">Create</span>;</span>
<span class="hljs-keyword">begin</span>
    Str := <span class="hljs-string">'单例模式测试'</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSingle</span>.<span class="hljs-title">FreeInstance</span>;</span>
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">inherited</span>;
    GlobalSingle := <span class="hljs-keyword">nil</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">class</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSingle</span>.<span class="hljs-title">GetInstance</span>:</span> TSingle;
<span class="hljs-keyword">begin</span>
    <span class="hljs-comment">//判断当前全局变量GlobalSingle不空则创建对象,这里在并发环境下存在安全隐患</span>
    <span class="hljs-keyword">if</span> GlobalSingle = <span class="hljs-keyword">nil</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">begin</span>
        GlobalSingle := TSingle.create();
    <span class="hljs-keyword">end</span>;
    Result := GlobalSingle;
<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">class</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSingle</span>.<span class="hljs-title">NewInstance</span>:</span> TObject;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">if</span> GlobalSingle = <span class="hljs-keyword">nil</span> <span class="hljs-keyword">then</span>
        <span class="hljs-comment">//重载方法通过父类  NewInstance方法获取对象，强制转换为 TSingle类型</span>
        GlobalSingle := TSingle(<span class="hljs-keyword">inherited</span> NewInstance);
    Result := GlobalSingle;
<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">end</span>.
</code></pre>
<p>测试代码</p>
<pre><code class="lang-pascal hljs"><span class="hljs-keyword">program</span> ProjectSingle;

<span class="hljs-meta">{$APPTYPE CONSOLE}</span>
<span class="hljs-meta">{$R *.res}</span>

<span class="hljs-keyword">uses</span>
    System.SysUtils,
    System.Types,
    uCommonUtil <span class="hljs-keyword">in</span> <span class="hljs-string">'uCommonUtil.pas'</span>;

<span class="hljs-keyword">var</span>
    P1, P2: Pointer;

<span class="hljs-keyword">begin</span>

    <span class="hljs-keyword">try</span>
        <span class="hljs-keyword">var</span> com1 := TSingle.GetInstance();
        p1 := com1;
        P2 := TSingle.GetInstance();
        <span class="hljs-comment">//通过输出的地址可见是同一个对象</span>
        writeln(IntToStr(Integer(p2)));
        writeln(IntToStr(Integer(p1)));
    <span class="hljs-keyword">except</span>
        <span class="hljs-keyword">on</span> e: Exception <span class="hljs-keyword">do</span>
            writeln(e.<span class="hljs-keyword">Message</span>);
    <span class="hljs-keyword">end</span>;

    readln;

<span class="hljs-keyword">end</span>.
</code></pre>

    </div>
</div>
</div>

<div id="container-floating" style="display:none;" class="d-none d-md-block d-xl-block">
    <div id="floating-button" onclick="toggleMore()">
        <p id="floating-more" class="more">&gt;</p>
    </div>
</div>

<!--
<div class="footer" id="vnote-footer">
    <p>Generated by <em><a href="https://tamlok.github.io/vnote/">VNote</a></em>.</p>
</div>
-->
</body>
</html>
